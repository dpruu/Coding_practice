# 스토어드 프로시저



## 스토어드 프로시저 사용 방법

### 1. 스토어드 프로시저 기본

- 형식
  - $$는 $1개만 사용해도 된다.

```sql
DELIMITER $$
CREATE PROCEDURE 스토어드_프로시저_이름 ( IN 또는 OUT 매개변수 )
BEGIN
	-- 코드
END $$ 
DELIMITER ;
```

```SQL
CALL 스토어드_프로시저_이름();
```



#### ① 스토어드 프로시저 생성

```SQL
USE market_db;
DROP PROCEDURE IF EXISTS user_proc;
DELIMITER $$
CREATE PROCEDURE user_proc()
BEGIN
	SELECT * FROM member;
END $$
DELIMITER ;

CALL user_proc();
```

![image-20220112105441653](markdown-images/image-20220112105441653.png)

#### ② 스토어드 프로시저 삭제

```SQL
DROP PROCEDURE user_proc;
```



### 2. 스토어드 프로시저 실습

#### ① 매개변수의 사용

- 입력 매개변수 지정

```SQL
IN 입력_매개변수_이름 데이터_형식
```

```SQL
CALL 프로시저_이름(전달_값);
```

- 출력 매개변수 지정

```SQL
OUT 출력_매개변수_이름 데이터_형식
```

```SQL
CALL 프로시저_이름(@변수명)
SELECT @변수명
```



#### ② 입력 매개변수의 활용

- 입력이 1개일 때

```SQL
USE market_db;
DROP PROCEDURE IF EXISTS user_proc1;
DELIMITER $$
CREATE PROCEDURE user_proc1(IN userName VARCHAR(10))
BEGIN
	SELECT * FROM member WHERE mem_name = userName;
END $$
DELIMITER ;

CALL user_proc1('에이핑크')
```

![image-20220112110058256](markdown-images/image-20220112110058256.png)

- 2개의 입력 매개변수

```SQL
DROP PROCEDURE IF EXISTS user_proc2;
DELIMITER $$
CREATE PROCEDURE user_proc2(
    IN userNumber INT,
	IN userHeight INT )
BEGIN
	SELECT * FROM member
    WHERE mem_number > userNumber AND height > userHeight;
END $$
DELIMITER ;

CALL user_proc2(6,165);
```

![image-20220112110648177](markdown-images/image-20220112110648177.png)

#### ③ 출력 매개변수의 활용

```SQL
DROP PROCEDURE IF EXISTS user_proc3;
DELIMITER $$
CREATE PROCEDURE user_proc3(
    IN txtValue CHAR(10),
	OUT outValue INT )
BEGIN
	INSERT INTO noTabe VALUES(NULL,txtValue);
	SELECT MAX(id) INTO outValue FROM noTable;
END $$
DELIMITER ;

CREATE TABLE IF NOT EXISTS noTable(
	id INT AUTO_INCREMENT PRIMARY KEY,
	txt CHAR(10)
);
```

- 스토어드 프로시저를 만드는 시점에 아직 존재하지 않는 테이블을 사용해도 프로시저 생성에는 문제가 없다.

```SQL
CALL user_proc3('테스트1', @myValue);
SELECT CONCAT('입력된 ID 값 ==>', @myValue);
```

![image-20220112111400010](markdown-images/image-20220112111400010.png)

#### ④ SQL 프로그래밍의 활용

- IF ~ ELSE 문

```SQL
DROP PROCEDURE IF EXISTS ifelse_proc;
DELIMITER $$
CREATE PROCEDURE ifelse_proc(
    IN memName VARCHAR(10)
)
BEGIN
	DECLARE debutYear INT;
	SELECT YEAR(debut_date) INTO debutYear FROM member
		WHERE mem_name = memName;
	IF (debutYear >= 2015) THEN
		SELECT '신인 가수' AS '메시지';
	ELSE
		SELECT '고참 가수' AS '메시지';
	END IF;
END $$
DELIMITER ;

CALL ifelse_proc('오마이걸')
```

![image-20220112113219604](markdown-images/image-20220112113219604.png)

> ※ 날짜 함수
>
> YEAR(날짜), MONTH(날짜), DAY(날짜)는 각각 날짜에서 연,월,일을 구한다. CURDATE()는 현재 날짜를 확인.
>
> SELECT YEAR(CURDATE()), MONTH(CURDATE()), DAY(CURDATE())

- WHILE 문

```SQL
DROP PROCEDURE IF EXISTS while_proc;
DELIMITER $$
CREATE PROCEDURE while_proc()
BEGIN
	DECLARE hap INT;
	DECLARE num INT;
	SET hap = 0;
	SET num = 1;
	
	WHILE (num <= 100) DO
		SET hap = hap+num;
		SET num = num+1;
	END WHILE;
	SELECT hap AS '1~100 합계';
	
END $$
DELIMITER ;
CALL while_proc();
```

![image-20220112113804071](markdown-images/image-20220112113804071.png)

- 동적 SQL

```SQL
DROP PROCEDURE IF EXISTS dynamic_proc;
DELIMITER $$
CREATE PROCEDURE dynamic_proc(
	IN tableName VARCHAR(20)
)
BEGIN
	SET @sqlQuery = CONCAT('SELECT * FROM ', tableName); -- 문자열 생성
	PREPARE myQuery, FROM @sqlQuery; 
	EXECUTE myQuery; -- 문자열 실행
	DEALLOCATE PREPARE myQuery; -- myQuery 해제
	
END $$
DELIMITER ;

CALL dynamic_proc('member');
```

